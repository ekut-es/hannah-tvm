From 3248bad24655eb48a226ef250bface18b68ccbae Mon Sep 17 00:00:00 2001
From: Christoph Gerum <christoph.gerum@uni-tuebingen.de>
Date: Wed, 16 Jun 2021 11:43:15 +0200
Subject: [PATCH] Enable stm32f429i discovery board

---
 .../zephyr/aot_demo/boards/stm32f429i_disc1.conf   | 31 ++++++++++++++++++++++
 apps/microtvm/zephyr/aot_demo/src/main.c           |  5 +++-
 .../host_driven/boards/stm32f429i_disc1.conf       | 31 ++++++++++++++++++++++
 apps/microtvm/zephyr/host_driven/src/main.c        |  2 +-
 python/tvm/micro/contrib/zephyr.py                 |  5 ++--
 python/tvm/target/target.py                        |  1 +
 6 files changed, 71 insertions(+), 4 deletions(-)
 create mode 100644 apps/microtvm/zephyr/aot_demo/boards/stm32f429i_disc1.conf
 create mode 100644 apps/microtvm/zephyr/host_driven/boards/stm32f429i_disc1.conf

diff --git a/apps/microtvm/zephyr/aot_demo/boards/stm32f429i_disc1.conf b/apps/microtvm/zephyr/aot_demo/boards/stm32f429i_disc1.conf
new file mode 100644
index 000000000..34d8cdd76
--- /dev/null
+++ b/apps/microtvm/zephyr/aot_demo/boards/stm32f429i_disc1.conf
@@ -0,0 +1,31 @@
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#   http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing,
+# software distributed under the License is distributed on an
+# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+# KIND, either express or implied.  See the License for the
+# specific language governing permissions and limitations
+# under the License.
+#
+# This file is specific to the STM32F429i Discovery board.
+
+# For intrinsics used by generated optimized operators.
+CONFIG_CMSIS_DSP=y
+
+# For operations that stack allocates a large float array.
+CONFIG_MAIN_STACK_SIZE=1536
+
+# For random number generation.
+CONFIG_TEST_RANDOM_GENERATOR=y
+CONFIG_TIMER_RANDOM_GENERATOR=y
+
+# For debugging.
+CONFIG_LED=y
\ No newline at end of file
diff --git a/apps/microtvm/zephyr/aot_demo/src/main.c b/apps/microtvm/zephyr/aot_demo/src/main.c
index b92366a70..90a3cb8b9 100644
--- a/apps/microtvm/zephyr/aot_demo/src/main.c
+++ b/apps/microtvm/zephyr/aot_demo/src/main.c
@@ -38,7 +38,7 @@
 #include "posix_board_if.h"
 #endif
 
-#define WORKSPACE_SIZE (270 * 1024)
+#define WORKSPACE_SIZE (128 * 1024)
 
 static uint8_t g_aot_memory[WORKSPACE_SIZE];
 extern tvm_model_t network;
@@ -215,12 +215,15 @@ void main(void) {
 
   size_t max_ind = -1;
   float max_val = -FLT_MAX;
+  TVMLogf("#result_data*1000:");
   for (size_t i = 0; i < output_data_len; i++) {
     if (output_data[i] >= max_val) {
       max_ind = i;
       max_val = output_data[i];
+      TVMLogf(" %d", (int)(output_data[i]*1000));
     }
   }
+  TVMLogf("\n");
   TVMLogf("#result:%d:%d\n", max_ind, (uint32_t)(elapsed_time * 1000));
 #ifdef CONFIG_ARCH_POSIX
   posix_exit(0);
diff --git a/apps/microtvm/zephyr/host_driven/boards/stm32f429i_disc1.conf b/apps/microtvm/zephyr/host_driven/boards/stm32f429i_disc1.conf
new file mode 100644
index 000000000..34d8cdd76
--- /dev/null
+++ b/apps/microtvm/zephyr/host_driven/boards/stm32f429i_disc1.conf
@@ -0,0 +1,31 @@
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#   http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing,
+# software distributed under the License is distributed on an
+# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+# KIND, either express or implied.  See the License for the
+# specific language governing permissions and limitations
+# under the License.
+#
+# This file is specific to the STM32F429i Discovery board.
+
+# For intrinsics used by generated optimized operators.
+CONFIG_CMSIS_DSP=y
+
+# For operations that stack allocates a large float array.
+CONFIG_MAIN_STACK_SIZE=1536
+
+# For random number generation.
+CONFIG_TEST_RANDOM_GENERATOR=y
+CONFIG_TIMER_RANDOM_GENERATOR=y
+
+# For debugging.
+CONFIG_LED=y
\ No newline at end of file
diff --git a/apps/microtvm/zephyr/host_driven/src/main.c b/apps/microtvm/zephyr/host_driven/src/main.c
index 637a58ae9..dd5cba566 100644
--- a/apps/microtvm/zephyr/host_driven/src/main.c
+++ b/apps/microtvm/zephyr/host_driven/src/main.c
@@ -130,7 +130,7 @@ tvm_crt_error_t TVMPlatformGenerateRandom(uint8_t* buffer, size_t num_bytes) {
 }
 
 // Heap for use by TVMPlatformMemoryAllocate.
-K_HEAP_DEFINE(tvm_heap, 216 * 1024);
+K_HEAP_DEFINE(tvm_heap, 128 * 1024);
 
 // Called by TVM to allocate memory.
 tvm_crt_error_t TVMPlatformMemoryAllocate(size_t num_bytes, DLDevice dev, void** out_ptr) {
diff --git a/python/tvm/micro/contrib/zephyr.py b/python/tvm/micro/contrib/zephyr.py
index 2f85b3573..b02ed03a3 100644
--- a/python/tvm/micro/contrib/zephyr.py
+++ b/python/tvm/micro/contrib/zephyr.py
@@ -221,7 +221,7 @@ class ZephyrCompiler(tvm.micro.Compiler):
         build_dir = os.path.join(output, "__tvm_build")
         os.mkdir(build_dir)
         self._subprocess_env.run(
-            ["cmake", "..", f"-DBOARD={self._board}"] + self._options_to_cmake_args(options),
+            [os.getenv("CMAKE", "cmake"), "..", f"-DBOARD={self._board}"] + self._options_to_cmake_args(options),
             cwd=build_dir,
         )
         num_cpus = multiprocessing.cpu_count()
@@ -257,7 +257,7 @@ class ZephyrCompiler(tvm.micro.Compiler):
 
         # expected not to exist after populate_tvm_objs
         cmake_args = [
-            "cmake",
+            os.getenv("CMAKE", "cmake"),
             os.path.abspath(self._project_dir),
             f"-DBOARD={self._board}",
         ] + self._options_to_cmake_args(options)
@@ -408,6 +408,7 @@ class ZephyrFlasher(tvm.micro.compiler.Flasher):
     BOARD_USB_FIND_KW = {
         "nucleo_f746zg": {"idVendor": 0x0483, "idProduct": 0x374B},
         "stm32f746g_disco": {"idVendor": 0x0483, "idProduct": 0x374B},
+        "stm32f429i_disc1": {"idVendor": 0x0483, "idProduct": 0x374B}
     }
 
     def openocd_serial(self, cmake_entries):
diff --git a/python/tvm/target/target.py b/python/tvm/target/target.py
index be39a6f6b..2b23460b8 100644
--- a/python/tvm/target/target.py
+++ b/python/tvm/target/target.py
@@ -277,6 +277,7 @@ def intel_graphics(model="unknown", options=None):
 MICRO_SUPPORTED_MODELS = {
     "host": [],
     "stm32f746xx": ["-mcpu=cortex-m7", "-march=armv7e-m"],
+    "stm32f4xx": ["-mcpu=cortex-m4", "-march=armv7e-m"],
     "nrf5340dk": ["-mcpu=cortex-m33"],
     "mps2_an521": ["-mcpu=cortex-m33"],
 }
-- 
2.16.6

